<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倉川社長チャットボット</title>
    <link rel="icon" href="{{ url_for('static', filename='images/bot-icon.png') }}" type="image/png">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }
        #left-container {
            width: 45%;
            height: 100vh;
            background-color: #f0f0f0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #right-container {
            width: 55%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            overflow: hidden;
            border-left: 2px solid #e0e0e0;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
        #loading-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        progress {
            width: 300px;
            height: 20px;
        }
        .chat-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
            background-color: white;
            overflow: hidden;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .message.user {
            justify-content: flex-end;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: None;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        .message.user .avatar {
            order: 1;
            margin-right: 0;
            margin-left: 10px;
            background-color: #28a745;
        }
        .message-content {
            padding: 10px;
            border-radius: 18px;
            background-color: #f1f0f0;
            max-width: 80%;
        }
        .message-content p, .message-content li {
            margin: 0.2em;
            line-height: 1.2;
        }
        .message.user .message-content {
            background-color: #007bff;
            color: white;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
        }
        #user-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
            height: 40px;
            resize: none;
        }
        #user-input:disabled {
            background-color: #e0e0e0;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #send-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js",
                "GLTFLoader": "https://cdn.jsdelivr.net/npm/three@0.167.0/examples/jsm/loaders/GLTFLoader.js",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.min.js",
                "@pixiv/three-vrm-animation": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm-animation/lib/three-vrm-animation.module.js"
            }
        }
    </script>
</head>
<body>

    <div id="left-container">
        <div id="loading-container">
            <p>モデルを読み込んでいます...</p>
            <progress id="loading-bar" value="0" max="100"></progress>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <div id="right-container">
        <div class="chat-container">
            <div id="chat-messages" class="chat-messages">
                <div class="message assistant">
                    <div class="avatar">
                        <img src="/static/images/bot-icon.png" alt="Bot" style="width: 40px; height: 40px; border-radius: 50%;">
                    </div>
                    <div class="message-content">こんにちは！どのようなことでお手伝いできますか？</div>
                </div>
            </div>
            <div class="chat-input">
                <textarea id="user-input" placeholder="メッセージを入力..."></textarea>
                <button id="send-button">送信</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'GLTFLoader';
        import { VRMLoaderPlugin } from '@pixiv/three-vrm';
        import { createVRMAnimationClip, VRMAnimationLoaderPlugin } from '@pixiv/three-vrm-animation';

        let currentMixer = undefined;
        let idleAction = undefined;
        let typingAction = undefined;
        let specialAction = undefined;
        let AnsweringAction = undefined;
        let currentVrm = undefined;
        let idleTimer = null;

        function stopAllActions() {
            if (idleAction) idleAction.stop();
            if (typingAction) typingAction.stop();
            if (specialAction) specialAction.stop();
            if (AnsweringAction) AnsweringAction.stop();
        }

        function startIdleTimer() {
            clearIdleTimer();
            idleTimer = setTimeout(() => {
                stopAllActions();
                if (idleAction) {
                    currentVrm.humanoid.resetPose();
                    idleAction.reset().play();
                    idleAction.loop = THREE.LoopRepeat;
                }
            }, 60000);
        }

        function clearIdleTimer() {
            if (idleTimer) {
                clearTimeout(idleTimer);
                idleTimer = null;
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            const canvas = document.getElementById("canvas");
            const loadingContainer = document.getElementById("loading-container");
            const loadingBar = document.getElementById("loading-bar");

            if (canvas == null) return;

            const scene = new THREE.Scene();
            const textureLoader = new THREE.TextureLoader();
            const backgroundTexture = textureLoader.load('/static/models/ttc-back.jpg');
            scene.background = backgroundTexture;

            const camera = new THREE.PerspectiveCamera(30, canvas.clientWidth / canvas.clientHeight, 0.1, 20);
            camera.position.set(0, 1, -1.7);
            camera.rotation.set(0.0, Math.PI, 0.0);

            const renderer = new THREE.WebGLRenderer({ canvas });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setClearColor(0x7fbfff, 1.0);

            const light = new THREE.DirectionalLight(0xffffff, Math.PI);
            light.position.set(1.0, 1.0, 1.0);
            scene.add(light);

            function load(url) {
                loader.load(
                    url,
                    (gltf) => {
                        tryInitVRM(gltf);
                        loadingContainer.style.display = 'none';
                    },
                    (progress) => {
                        const percentComplete = (progress.loaded / progress.total) * 100;
                        loadingBar.value = percentComplete;
                        console.log("Loading model...", percentComplete.toFixed(2), "%");
                    },
                    (error) => console.error(error)
                );
            }

            function tryInitVRM(gltf) {
                const vrm = gltf.userData.vrm;
                if (vrm == null) return;
                currentVrm = vrm;
                scene.add(vrm.scene);
                initAnimationClip();
            }

            function initAnimationClip() {
                if (currentVrm) {
                    currentMixer = new THREE.AnimationMixer(currentVrm.scene);

                    loadAnimation('/static/motions/vrma/挨拶.vrma').then((clip) => {
                        specialAction = currentMixer.clipAction(clip);
                        specialAction.play();
                        specialAction.loop = THREE.LoopOnce;
                        specialAction.clampWhenFinished = true;
                    });

                    loadAnimation('/static/motions/vrma/屈伸運動.vrma').then((clip) => {
                        idleAction = currentMixer.clipAction(clip);
                    });

                    loadAnimation('/static/motions/vrma/vpdloop_thinking.vrma').then((clip) => {
                        typingAction = currentMixer.clipAction(clip);
                    });

                    loadAnimation('/static/motions/vrma/vpdloop_answering.vrma').then((clip) => {
                        AnsweringAction = currentMixer.clipAction(clip);
                    });
                }
            }

            function loadAnimation(url) {
                return new Promise((resolve) => {
                    loader.load(url, (gltf) => {
                        const clip = createVRMAnimationClip(gltf.userData.vrmAnimations[0], currentVrm);
                        resolve(clip);
                    });
                });
            }

            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));
            loader.register((parser) => new VRMAnimationLoaderPlugin(parser));

            load("/static/models/vrm/ttc-president-20240917.vrm");

            const clock = new THREE.Clock();
            clock.start();

            const update = () => {
                requestAnimationFrame(update);
                const deltaTime = clock.getDelta();
                if (currentMixer) currentMixer.update(deltaTime);
                if (currentVrm) currentVrm.update(deltaTime);
                renderer.render(scene, camera);
            };
            update();

            startIdleTimer();
        });

        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        function addMessage(role, content, isMarkdown = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';

            const img = document.createElement('img');
            img.src = role === 'user' ? '/static/images/user-icon.png' : '/static/images/bot-icon.png';
            img.alt = role === 'user' ? 'User' : 'Bot';
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.borderRadius = '50%';
            avatarDiv.appendChild(img);

            messageDiv.appendChild(avatarDiv);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = isMarkdown ? marked.parse(content) : content;
            messageDiv.appendChild(contentDiv);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        sendButton.addEventListener('click', () => {
            handleSend();
            clearIdleTimer();  
            startIdleTimer();
        });

        userInput.addEventListener('input', () => {
            clearIdleTimer();  
            startIdleTimer();
        });

        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendButton.click();
            }
        });

        function handleSend() {
            const message = userInput.value.trim();
            if (message) {
                userInput.disabled = true;
                sendButton.disabled = true;

                addMessage('user', message);
                userInput.value = '';

                stopAllActions();
                if (typingAction) typingAction.reset().play();

                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                }).then(response => {
                    const reader = response.body.getReader();

                    const botMessageDiv = document.createElement('div');
                    botMessageDiv.className = 'message assistant';

                    const botAvatarDiv = document.createElement('div');
                    botAvatarDiv.className = 'avatar';
                    const botImg = document.createElement('img');
                    botImg.src = '/static/images/bot-icon.png';
                    botImg.alt = 'Bot';
                    botImg.style.width = '40px';
                    botImg.style.height = '40px';
                    botImg.style.borderRadius = '50%';
                    botAvatarDiv.appendChild(botImg);
                    botMessageDiv.appendChild(botAvatarDiv);

                    const botMessageContent = document.createElement('div');
                    botMessageContent.className = 'message-content';
                    botMessageDiv.appendChild(botMessageContent);
                    chatMessages.appendChild(botMessageDiv);

                    let buffer = "";

                    function readStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                botMessageContent.innerHTML = marked.parse(buffer.trim());
                                buffer = "";

                                stopAllActions();
                                if (AnsweringAction) AnsweringAction.reset().play();
                                AnsweringAction.loop = THREE.LoopOnce;
                                AnsweringAction.clampWhenFinished = true;
                                userInput.disabled = false;
                                sendButton.disabled = false;
                                userInput.focus();

                                clearIdleTimer();  
                                startIdleTimer();  
                                return;
                            }

                            const decodedValue = new TextDecoder().decode(value);
                            buffer += decodedValue;
                            botMessageContent.textContent += decodedValue;
                            chatMessages.scrollTop = chatMessages.scrollHeight;

                            readStream();
                        });
                    }
                    readStream();
                });
            }
        }
    </script>
</body>
</html>
